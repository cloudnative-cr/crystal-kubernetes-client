name: Update Kubernetes API Spec

on:
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-spec:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest

      - name: Download latest Kubernetes OpenAPI spec
        run: |
          echo "Downloading latest Kubernetes OpenAPI specification..."
          curl -L https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json -o swagger.json.new

          # Check if the spec has changed
          if cmp -s swagger.json swagger.json.new; then
            echo "No changes in OpenAPI spec"
            echo "spec_changed=false" >> $GITHUB_ENV
            rm swagger.json.new
          else
            echo "OpenAPI spec has changed"
            echo "spec_changed=true" >> $GITHUB_ENV
            mv swagger.json.new swagger.json
          fi

      - name: Install dependencies
        if: env.spec_changed == 'true'
        run: shards install

      - name: Generate API bindings
        if: env.spec_changed == 'true'
        run: |
          echo "Generating API bindings from updated OpenAPI spec..."
          make generate

      - name: Run tests
        if: env.spec_changed == 'true'
        run: |
          echo "Running test suite to verify generated code..."
          crystal spec

      - name: Get Kubernetes version
        if: env.spec_changed == 'true'
        id: k8s-version
        run: |
          # Extract version from swagger.json
          VERSION=$(jq -r '.info.version' swagger.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Kubernetes version: $VERSION"

      - name: Create Pull Request
        if: env.spec_changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update Kubernetes API spec to ${{ steps.k8s-version.outputs.version }}

            Automated update of Kubernetes OpenAPI specification and generated bindings.

            - Updated swagger.json from kubernetes/kubernetes master branch
            - Regenerated API bindings (models and API methods)
            - All tests passing
          branch: automated/update-api-spec-${{ steps.k8s-version.outputs.version }}
          delete-branch: true
          title: "Update Kubernetes API spec to ${{ steps.k8s-version.outputs.version }}"
          body: |
            ## Automated API Spec Update

            This PR updates the Kubernetes OpenAPI specification and regenerates all API bindings.

            **Kubernetes Version:** `${{ steps.k8s-version.outputs.version }}`

            ### Changes
            - Updated `swagger.json` from [kubernetes/kubernetes](https://github.com/kubernetes/kubernetes/tree/master/api/openapi-spec)
            - Regenerated all API models and methods in `src/generated/`
            - Test suite: ✓ All tests passing

            ### Testing
            The test suite has been run and all tests pass:
            ```bash
            crystal spec
            # 78 examples, 0 failures, 0 errors, 0 pending
            ```

            ### Review Checklist
            - [ ] Review generated code changes in `src/generated/models/`
            - [ ] Review generated code changes in `src/generated/api/`
            - [ ] Verify no breaking changes to public API
            - [ ] Check for new Kubernetes resource types
            - [ ] Verify test suite passes locally

            ---

            Generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            automated
            dependencies
            api-update
          assignees: pfeifferj
          draft: false

      - name: Summary
        if: env.spec_changed == 'true'
        run: |
          echo "✓ Kubernetes API spec updated to ${{ steps.k8s-version.outputs.version }}"
          echo "✓ API bindings regenerated"
          echo "✓ Tests passing"
          echo "✓ Pull request created"

      - name: No changes
        if: env.spec_changed == 'false'
        run: |
          echo "No changes detected in Kubernetes OpenAPI spec"
          echo "Skipping code generation and PR creation"
